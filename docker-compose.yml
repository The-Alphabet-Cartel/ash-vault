# ============================================================================
# Ash-Vault: Crisis Archive & Backup Infrastructure
# The Alphabet Cartel - https://discord.gg/alphabetcartel | alphabetcartel.org
# ============================================================================
#
# MISSION - NEVER TO BE VIOLATED:
#     Secure     → Encrypt sensitive session data with defense-in-depth layering
#     Archive    → Preserve crisis records in resilient object storage
#     Replicate  → Maintain backups across device, site, and cloud tiers
#     Protect    → Safeguard our LGBTQIA+ community through vigilant data guardianship
#
# ============================================================================
# Docker Compose Configuration - Backup Service
# ----------------------------------------------------------------------------
# FILE VERSION: v5.0-3-3.5a-1
# LAST MODIFIED: 2026-01-09
# PHASE: Phase 3 - Backup Infrastructure
# CLEAN ARCHITECTURE: Compliant
# Repository: https://github.com/the-alphabet-cartel/ash-vault
# ============================================================================
#
# USAGE:
#   # Start services
#   docker compose up -d
#
#   # View logs
#   docker compose logs -f ash-vault-backup
#
#   # Stop services
#   docker compose down
#
#   # Rebuild and start
#   docker compose up -d --build
#
# NOTE:
#   MinIO runs separately via /opt/minio/docker-compose.yml on Syn VM.
#   This compose file is for the Python backup service only.
#
# SECRETS:
#   Secrets are stored in ./secrets/ directory:
#   - ./secrets/discord_alert_token - Discord webhook for alerts (optional)
#
# REQUIREMENTS:
#   - Docker Engine 24.0+
#   - Docker Compose v2.20+
#
# ============================================================================

### Common Variables ###
x-common: &common
  restart: unless-stopped

### Common Environmental Variables ###
x-env: &env
  TZ: America/Los_Angeles

### Healthchecks ###
x-health: &health
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 30s
  start_interval: 10s

services:
  # ===========================================================================
  # Ash-Vault Backup Service
  # ===========================================================================
  ash-vault-backup:
    image: ghcr.io/the-alphabet-cartel/ash-vault:latest
    container_name: ash-vault-backup
    build:
      context: .
      dockerfile: Dockerfile
    <<: *common

    # Required for ZFS operations
    privileged: true

    # Resource limits (production)
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

    # Environment variables
    environment:
      <<: *env
      VAULT_ENVIRONMENT: production
      VAULT_LOG_LEVEL: INFO
      # ZFS Configuration
      VAULT_ZFS_POOL: syn
      VAULT_ZFS_DATASET: syn/archives
      VAULT_ZFS_MOUNTPOINT: /mnt/archives
      # Lofn Replication
      VAULT_LOFN_HOST: "10.20.30.253"
      VAULT_LOFN_DATASET: backup/ash-vault
      # Backblaze B2
      VAULT_B2_BUCKET: ash-vault-backup-alphabetcartel

    # Volume Mounts
    volumes:
      # Logs
      - ./logs:/app/logs
      # ZFS commands need access to host ZFS
      - /dev/zfs:/dev/zfs
      # SSH keys for Lofn replication
      - /root/.ssh:/root/.ssh:ro
      # Rclone config for B2 sync
      - /root/.config/rclone:/root/.config/rclone:ro
      # ZFS dataset (for rclone to read)
      - /mnt/archives:/mnt/archives:ro

    # Port mapping for health endpoint
    ports:
      - "30886:30886"

    # Docker Secrets
    secrets:
      - discord_alert_token

    # Health check - uses HTTP endpoint from health server
    healthcheck:
      <<: *health
      test: ["CMD", "curl", "-f", "http://localhost:30886/health"]

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    # Labels for organization
    labels:
      - "org.alphabetcartel.service=ash-vault"
      - "org.alphabetcartel.version=5.0.3"
      - "org.alphabetcartel.description=Ash Crisis Archive & Backup Infrastructure"

# =============================================================================
# Secrets
# =============================================================================
secrets:
  discord_alert_token:
    file: ./secrets/discord_alert_token

# =============================================================================
# Notes
# =============================================================================
# This compose file runs the Python backup service that handles:
#   - ZFS snapshot creation and rotation
#   - ZFS replication to Lofn (via SSH)
#   - Backblaze B2 cloud sync (via rclone)
#   - Health endpoint on port 30886
#
# MinIO is deployed separately in /opt/minio/docker-compose.yml
# See docs/v5.0/phase2/planning.md for MinIO setup
# =============================================================================
