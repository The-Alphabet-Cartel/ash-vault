# ============================================================================
# Ash-Vault: Crisis Archive & Backup Infrastructure
# The Alphabet Cartel - https://discord.gg/alphabetcartel | alphabetcartel.org
# ============================================================================
#
# MISSION - NEVER TO BE VIOLATED:
#     Secure     → Encrypt sensitive session data with defense-in-depth layering
#     Archive    → Preserve crisis records in resilient object storage
#     Replicate  → Maintain backups across device, site, and cloud tiers
#     Protect    → Safeguard our LGBTQIA+ community through vigilant data guardianship
#
# ============================================================================
# Docker Compose Configuration - Complete Ash-Vault Stack
# ----------------------------------------------------------------------------
# FILE VERSION: v5.0-3-3.6-1
# LAST MODIFIED: 2026-01-09
# PHASE: Phase 3 - Backup Infrastructure
# CLEAN ARCHITECTURE: Compliant
# Repository: https://github.com/the-alphabet-cartel/ash-vault
# ============================================================================
#
# SERVICES:
#   - minio: S3-compatible object storage (ports 30884/30885)
#   - ash-vault-backup: Backup automation service (port 30886)
#
# USAGE:
#   # Start all services
#   docker compose up -d
#
#   # View logs
#   docker compose logs -f
#
#   # Rebuild and start
#   docker compose up -d --build
#
#   # Stop all services
#   docker compose down
#
# SECRETS (create in ./secrets/):
#   - minio_root_user         - MinIO admin username
#   - minio_root_password     - MinIO admin password
#   - discord_alert_token     - Discord webhook URL (optional)
#
# REQUIREMENTS:
#   - Docker Engine 24.0+
#   - Docker Compose v2.20+
#   - ZFS dataset mounted at /mnt/archives
#
# ============================================================================

### Common Variables ###
x-common: &common
  restart: unless-stopped

### Common Environmental Variables ###
x-env: &env
  TZ: America/Los_Angeles

### Healthchecks ###
x-health: &health
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 30s

services:
  # ===========================================================================
  # MinIO Object Storage
  # ===========================================================================
  minio:
    image: minio/minio:latest
    container_name: minio
    <<: *common
    
    command: server /data --console-address ":30885" --address ":30884"
    
    environment:
      <<: *env
      MINIO_ROOT_USER_FILE: /run/secrets/minio_root_user
      MINIO_ROOT_PASSWORD_FILE: /run/secrets/minio_root_password
    
    ports:
      - "30884:30884"   # S3 API
      - "30885:30885"   # Web Console
    
    volumes:
      - /mnt/archives/minio-data:/data
    
    secrets:
      - minio_root_user
      - minio_root_password
    
    healthcheck:
      <<: *health
      test: ["CMD", "curl", "-f", "http://localhost:30884/minio/health/live"]
      start_period: 10s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    labels:
      - "org.alphabetcartel.service=ash-vault-minio"
      - "org.alphabetcartel.version=5.0.3"
      - "org.alphabetcartel.description=Ash-Vault MinIO Object Storage"

  # ===========================================================================
  # Ash-Vault Backup Service
  # ===========================================================================
  ash-vault-backup:
    image: ghcr.io/the-alphabet-cartel/ash-vault:latest
    container_name: ash-vault-backup
    build:
      context: .
      dockerfile: Dockerfile
    <<: *common
    
    # Wait for MinIO to be healthy before starting
    depends_on:
      minio:
        condition: service_healthy

    # Required for ZFS operations
    privileged: true

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

    environment:
      <<: *env
      VAULT_ENVIRONMENT: production
      VAULT_LOG_LEVEL: INFO
      # ZFS Configuration
      VAULT_ZFS_POOL: syn
      VAULT_ZFS_DATASET: syn/archives
      VAULT_ZFS_MOUNTPOINT: /mnt/archives
      # Lofn Replication
      VAULT_LOFN_HOST: "10.20.30.253"
      VAULT_LOFN_DATASET: backup/ash-vault
      # Backblaze B2
      VAULT_B2_BUCKET: ash-vault-backup-alphabetcartel

    volumes:
      # Logs
      - ./logs:/app/logs
      # ZFS commands need access to host ZFS
      - /dev/zfs:/dev/zfs
      # SSH keys for Lofn replication
      - /root/.ssh:/root/.ssh:ro
      # Rclone config for B2 sync
      - /root/.config/rclone:/root/.config/rclone:ro
      # ZFS dataset (for rclone to read)
      - /mnt/archives:/mnt/archives:ro

    ports:
      - "30886:30886"   # Health/Status API

    secrets:
      - discord_alert_token

    healthcheck:
      <<: *health
      test: ["CMD", "curl", "-f", "http://localhost:30886/health"]

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    labels:
      - "org.alphabetcartel.service=ash-vault-backup"
      - "org.alphabetcartel.version=5.0.3"
      - "org.alphabetcartel.description=Ash-Vault Backup Automation Service"

# =============================================================================
# Secrets
# =============================================================================
secrets:
  minio_root_user:
    file: ./secrets/minio_root_user
  minio_root_password:
    file: ./secrets/minio_root_password
  discord_alert_token:
    file: ./secrets/discord_alert_token

# =============================================================================
# Notes
# =============================================================================
# Port Allocation:
#   - 30884: MinIO S3 API
#   - 30885: MinIO Web Console
#   - 30886: Backup Service Health API
#
# Data Storage:
#   - MinIO data: /mnt/archives/minio-data (ZFS encrypted)
#   - Backup logs: ./logs/
#
# Backup Schedule:
#   - Daily snapshots: 3 AM
#   - Weekly snapshots: 3 AM Sunday
#   - Monthly snapshots: 3 AM 1st
#   - Lofn replication: 4 AM daily
#   - B2 cloud sync: 5 AM Sunday
# =============================================================================
